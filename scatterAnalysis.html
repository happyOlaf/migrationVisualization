<!DOCTYPE html>
<html style="height: 100%">

<head>
    <meta charset="utf-8">
</head>

<body style="height: 100%; margin: 0">
    <div id="container" style="height: 100%"></div>
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.7.0/echarts.min.js"></script>
    <script type="text/javascript" src="assets/js/dat.gui.js"></script>
    <script type="text/javascript">
    var dataSet0 = []; //总数据集
    //获取某年所有国家GDP数据
    var yearFlag = 9095;
    var xAxisFlag = 'GDP';
    var yAxisFlag = 'NetMigrationRate';

    function getYearData(year) {
        var dataSet1 = [];
        //获取GDP数据
        //console.log(year);
        //console.log(year.toString());
        //var str = (year.toString()).substr(2, 2);
        var str = getGDPyear(year);
        console.log(str);
        $.ajaxSettings.async = false;
        var url_gdp = "http://localhost:8081/GPD/Year/" + str;
        $.getJSON(url_gdp, function(geojson) {
            $.each(geojson, function(i, val) {
                var temp = new Object();
                temp.country = val["area"];
                temp.GDP = (val["gpd"] / 100000000).toFixed(4);
                //console.log(temp.gdp);
                dataSet1.push(temp);

            });
        });
        //获取人均数据
        $.ajaxSettings.async = false;
        var url_pcgdp = 'http://localhost:8081/PerCapitaGDP/Year/' + str;
        $.getJSON(url_pcgdp, function(geojson) {
            $.each(geojson, function(i, val) {

                dataSet1[i].GDP_Per_Capita = val["gpd"].toFixed(4);
                var cty = dataSet1[i].country;
                var NMRS = getCountryNetMigrationRate(cty, year);
                if ($.isEmptyObject(NMRS)) {
                    //console.log(dataSet1[i].country);
                    dataSet1[i].NetMigrationRate = 0;
                } else {
                    dataSet1[i].NetMigrationRate = NMRS.nmr;
                    //console.log(dataSet1[i]);
                }
                var NMS = getCountryNetMigrationNumber(cty, year);
                if ($.isEmptyObject(NMS)) {
                    //console.log(dataSet1[i].country);
                    dataSet1[i].NetMigrationNumber = 0;
                } else {
                    dataSet1[i].NetMigrationNumber = NMS.nms;
                    //console.log(dataSet1[i]);
                }
            });
        })
        //console.log(dataSet1.length);
        return dataSet1;
    };

    function getGDPyear(year) {
        if (year == '9095') {
            return '1995'
        } else if (year == '9500') {
            return '2000'
        } else if (year == '0005') {
            return '2005'
        } else if (year == '0510') {
            return '2010'
        } else if (year == '1015') {
            return '2015'
        }
    }

    //获取某年某国家的净移民率
    function getCountryNetMigrationRate(country, year) {
        var tempNMR = new Object();

        //获取净移民率数据
        $.ajaxSettings.async = false;
        var url_nmr = 'http://localhost:8081/NetMigrationRate/Area/' + country;
        $.getJSON(url_nmr, function(geojson) {
            if ($.isEmptyObject(geojson)) {
                //console.log('404');
                return [];
            } else {
                str = 'netmigrationrate' + year;
                $.each(geojson, function(i, val) {
                    tempNMR.nmr = val[str];
                    //console.log(tempNMR);
                });
            }
        })
        return tempNMR;
    }

    //获取某年某国家的净移民数
    function getCountryNetMigrationNumber(country, year) {
        var tempNMS = new Object();

        //获取净移民率数据
        $.ajaxSettings.async = false;
        var url_nms = 'http://localhost:8081/NetMigration/Country/' + country;
        $.getJSON(url_nms, function(geojson) {
            if ($.isEmptyObject(geojson)) {
                //console.log('404');
                return [];
            } else {
                str = 'netmigrants' + year;
                $.each(geojson, function(i, val) {
                    tempNMS.nms = val[str];
                    //console.log(tempNMS);
                });
            }
        })
        return tempNMS;
    }

    dataSet0 = getYearData(9095);
    //getCountryNetMigrationRate("Burundi");



    var app = {};
    var dom = document.getElementById("container");
    var myChart = echarts.init(dom);
    var option = {
        backgroundColor: '#2c343c',
        tooltip: {

            padding: 10,
            backgroundColor: '#222',
            borderColor: '#777',
            borderWidth: 1,
            trigger: 'item',
            formatter: function(params) {
                //console.log(params.value[params.dimensionNames[params.encode.y[0]]]);
                //console.log(params.value['country']);
                //console.log(params);
                var cty = params.value['country'];
                var xaxs = params.value[params.dimensionNames[params.encode.x[0]]];
                var yaxs = params.value[params.dimensionNames[params.encode.y[0]]];
                var str = 'Country: ' + cty + '<br/>' + params.dimensionNames[params.encode.x[0]] + ': ' + xaxs + '<br/>' + params.dimensionNames[params.encode.y[0]] + ': ' + yaxs;
                return str;
            }


        },
        xAxis: {
            name: xAxisFlag,
            splitLine: { show: false },
            axisLine: {
                lineStyle: {
                    color: '#fff'
                }
            },
            axisLabel: {
                color: '#fff'
            },
            axisTick: {
                lineStyle: {
                    color: '#fff'
                }
            }
        },
        yAxis: {
            name: yAxisFlag,
            splitLine: { show: false },
            axisLine: {
                lineStyle: {
                    color: '#fff'
                }
            },
            axisLabel: {
                color: '#fff'
            },
            axisTick: {
                lineStyle: {
                    color: '#fff'
                }
            }
        },
        dataset: {
            // 提供一份数据。
            source: dataSet0
        },
        dataZoom: [{
                show: true,
                realtime: true,
                start: 0,
                end: 100
            },
            {
                type: 'inside',
                realtime: true,
                start: 0,
                end: 100
            }
        ],

        series: [{
            zlevel: 1,
            //name: 'nutrients',
            type: 'scatter',
            //data: [[1,2],[2,4],[4,8],[3,6]],
            encode: {
                //tooltip: ['country','gdp','nmr9095'],
                //tooltip: ['country', xAxisFlag, yAxisFlag],
                // 将 "amount" 列映射到 X 轴。
                x: xAxisFlag,
                // 将 "product" 列映射到 Y 轴。
                y: yAxisFlag
                //y: 'nmr9095'
            },
            itemStyle: {
                color: {
                    type: 'linear',
                    x: 0,
                    y: 0,
                    x2: 1,
                    y2: 1,
                    colorStops: [{
                        offset: 0,
                        color: 'rgb(223,90,90)' // 0% 处的颜色
                    }, 
                    // {
                    //     offset: 0.25,
                    //     color: 'rgb(223,176,90)' // 100% 处的颜色
                    // }, {
                    //     offset: 0.5,
                    //     color: 'rgb(223,148,90)' // 100% 处的颜色
                    // }, {
                    //     offset: 0.75,
                    //     color: 'rgb(223,119,90)' // 100% 处的颜色
                    // }, 
                    {
                        offset: 1,
                        color: 'rgb(223,119,90)' // 100% 处的颜色
                    }],
                    global: false // 缺省为 false
                }
            },
            animationThreshold: 5000,
            progressiveThreshold: 5000
        }],
        animationEasingUpdate: 'cubicInOut',
        animationDurationUpdate: 2000
    };

    //创建dat.GUI模块
    var obj = {
        year: '9095',
        xAxis: 'GDP',
        yAxis: 'NetMigrationRate'
    };

    var gui = new dat.gui.GUI();

    gui.remember(obj);

    var yearController = gui.add(obj, 'year', ['9095', '9500', '0005', '0510', '1015']);
    var gdpController = gui.add(obj, 'xAxis', ['GDP', 'GDP_Per_Capita']);
    var mController = gui.add(obj, 'yAxis', ['NetMigrationRate', 'NetMigrationNumber']);
    yearController.onChange(function(value) {//监听事件
        if (value != yearFlag) {
            //console.log(1);
            dataSet0 = getYearData(value);
            // myChart.setOption({
            //     dataset: {
            //         source: []
            //     }
            // });
            myChart.setOption({
                dataset: {
                    // 提供一份数据。
                    source: dataSet0
                },
                series: {
                    type: 'scatter',
                    encode: {
                        tooltip: ['country', xAxisFlag, yAxisFlag],
                        x: xAxisFlag,
                        y: yAxisFlag
                        //y: 'nmr9095'
                    },
                },
            });
            yearFlag = value;
        }

    });
    gdpController.onChange(function(value) {
        if (value != xAxisFlag) {
            xAxisFlag = value;
            //console.log('xAxisFlag');
            myChart.setOption({
                dataset: {
                    // 提供一份数据。
                    source: dataSet0
                },
                xAxis: {
                    name: xAxisFlag
                },
                yAxis: {
                    name: yAxisFlag
                },
                series: {
                    encode: {
                        type: 'scatter',
                        tooltip: ['country', xAxisFlag, yAxisFlag],
                        // 将 "amount" 列映射到 X 轴。
                        x: xAxisFlag,
                        // 将 "product" 列映射到 Y 轴。
                        y: yAxisFlag
                        //y: 'nmr9095'
                    },
                }
            });
        }
    });
    mController.onChange(function(value) {
        if (value != yAxisFlag) {
            yAxisFlag = value;
            //console.log('xAxisFlag');
            myChart.setOption({
                dataset: {
                    // 提供一份数据。
                    source: dataSet0
                },
                xAxis: {
                    name: xAxisFlag
                },
                yAxis: {
                    name: yAxisFlag
                },
                series: {
                    encode: {
                        type: 'scatter',
                        tooltip: ['country', xAxisFlag, yAxisFlag],
                        // 将 "amount" 列映射到 X 轴。
                        x: xAxisFlag,
                        // 将 "product" 列映射到 Y 轴。
                        y: yAxisFlag
                        //y: 'nmr9095'
                    },
                }
            });
        }
    });

    if (option && typeof option === "object") {
        myChart.setOption(option, true);
    }
    </script>
</body>

</html>