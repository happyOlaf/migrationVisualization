<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>routeVisualization</title>
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>  
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">   
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="assets/mapboxgl/include-web.js"></script>
    <script type="text/javascript" include="mapv" src="assets/mapboxgl/include-mapboxgl.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.7.0/echarts.min.js"></script>
    <link rel="stylesheet" href="assets/css/style.css"> <!-- Resource style -->
    <script src="assets/js/jquery-2.1.1.min.js"></script>
    <script src="assets/js/modernizr.js"></script> <!-- Modernizr -->
    <link rel="stylesheet" type="text/css" href="assets/css/switch-buttons.css">
    <script src="assets/js/worldZHjson.js"></script>
<style>
        body {
            margin: 0;
            padding: 0;
            background-color: rgba(0,0,0,1);
        }
        #SelContainer{
            position: absolute;
            width: 240px;
            top: 10px;
            left: 10px;
            border-radius: 10px;
            border: 1px solid;
            background-color: rgba(0,0,0,0.7);
        }
        #yearlist{
            position: absolute;
            right: 10px;
            width: 100px;
            height: 30px;
        }
        #raodnum{
        	position: absolute;
        	right: 10px;
        	width: 100px;
        	height: 30px;
        }
        #migrantnum{
        	position: absolute;
        	right: 10px;
        	width: 100px;
        	height: 30px;
        }
        #Graphcontainer{
        	position: absolute;
        	width:800px;
        	height: 680px;
        	margin: 0 auto;
        	background-color: white;
        	position: relative; /*脱离文档流*/
            top: 20px;
            bottom: 20px
        }
        #leftcharts{
        	position: absolute;
        	top: 200px;
        	width: 320px;
        	height: 500px;
        	border-radius: 10px;
        	background-color: white;
        }
        #rightContainer{
            position: absolute;
            top: 20px;
        	right:5px;
        	width: 340px;
        	height: 680px;
        	border-radius: 10px;
        	background-color: white;
        }
</style>
</head>
<body>
<div id="SelContainer">
    <div class="form-inline row"style="margin-top: 10px;margin-left: 5px;">
        <label class="form-inline"style="color: white;font-size: 12px;">年份</label> 
            <select id="yearlist"class="form-control">
                <option>1990</option>
                <option>1995</option>
                <option>2000</option>
                <option>2005</option>
                <option>2010</option>
                <option>2015</option>
                <option>2019</option>
            </select>
    </div>
    <div class="form-inline row"style="margin-top: 10px;margin-left: 5px;">
    	<label class="form-inline"style="color: white;font-size: 12px;">路径数</label> 
    	<input type="text" class="form-control" id="raodnum" οnkeyup="this.value=this.value.replace(/\D/g,'')"placeholder="1000">
    </div>
    <div class="form-inline row"style="margin-top: 10px;margin-left: 5px;margin-bottom:">
    	<label class="form-inline"style="color: white;font-size: 12px;">最少移民数量</label> 
    	<input type="text" class="form-control" id="migrantnum" οnkeyup="this.value=this.value.replace(/\D/g,'')"placeholder="50000">
    </div>
    <div style="margin-top: 10px;margin-bottom: 5px;">
    	<button type="button" id="submit" class="btn btn-warning" style="display:block;margin:0 auto">构建网络</button>
    </div>

</div>
    <div id="leftcharts"> 	
    </div>
    <div id="rightContainer">
    	
    </div>
<div id="Graphcontainer">
</div>
<script type="text/javascript">
	            /*var graphdata = {
                    node:[],
                    links:[],
                }
                graphdata.node.push({
                        attributes: {modularity_class: 1},
                        category: 1,
                        draggable: true,
                        id: "COL",
                        itemStyle: null,
                        label: {normal: {show:true}},
                        name: "COL",
                        symbolSize: 15.970149,
                        value: 15.970149,
                        x: -537.19727,
                        y: -196.96303,
                })
                graphdata.node.push({
                        attributes: {modularity_class: 0},
                        category: 0,
                        draggable: true,
                        id: "USA",
                        itemStyle: null,
                        label: {normal: {show:true}},
                        name: "USA",
                        symbolSize: 50,
                        value: 50,
                        x: -53.873672,
                        y: 48.316376,
                })
                console.log(graphdata);*/
        var curyear = "1990";
        var roaddata = [];
        var roadNum = 1000;   //边数
	     function getData(year){
	        //获取移入数据
	        $.ajaxSettings.async = false; 
	        http://localhost:8081/immigrantion/2005/Desc
	        var url = "http://localhost:8081/immigration/" + year + "/Desc";
	        $.getJSON(url, function (geojson) {
	            roaddata = geojson;
	        });
	     }
        getData(curyear);
        data = roaddata.slice(0,1000)
        console.log(data);

        //定义图结构存储变量
        var graphdata = {
            node:[],
            link:[],
        }

        //存储国家节点
        var countrylist = [];
        var countryOrderIn = [];
        var countryOrderout = [];
        var countryOrderAdd = [];
        //初始化出度入度数组和国家节点数组
        var countryIn = [];
        var countryOut = [];
        for(var i = 0; i < 232; i++){
            countryIn[countryCode[i][0]] = 0;
            countryOut[countryCode[i][0]] = 0;
            countrylist[countryCode[i][0]] = 0;
        }

        //度的统计
        for(var i = 0; i < roadNum; i++){
            countryIn[roaddata[i].to] += 1 ;
            countryOut[roaddata[i].from] += 1;
        }
        //出度和入度相加
        for(var i = 0; i < 232; i++){
            if (countryIn[countryCode[i][0]] > 0 ) {
                countrylist[countryCode[i][0]] += countryIn[countryCode[i][0]];               
            }
           if (countryIn[countryCode[i][0]] > 0 ) {
                countrylist[countryCode[i][0]] += countryOut[countryCode[i][0]];               
            }
        }

        //获得国家坐标
        function getCountryCoods(cName){
            for(var i = 0; i < countryCode.length; i++){           
                if( cName == countryCode[i][0]){
                    var coods = {"lng":0,"lat":0};
                    coods.lng = countryCode[i][4];
                    coods.lat = countryCode[i][3];
                    return coods;
                }
            }
        }

        //像图中添加节点
        var maxdeg = 0;  //最大度
        var n_class = 6;
        for (var index in countrylist){//这里需要使用for in语句进行访问
            /*console.log("countrylist["+index+"]  " + countrylist[index]);*/
            if (countrylist[index] > 0 ) {
                    graphdata.node.push({
                    /*attributes: {modularity_class: 1},
                    category: 1,*/
                    draggable: true,
                    id: index,
                    name: index,
                    symbolSize: countrylist[index]/1.5,
                    value: countrylist[index],
                })
            }
            if(countrylist[index]>maxdeg){
                maxdeg = countrylist[index];
            }

        }

        console.log(maxdeg)
        //设置节点属性
        graphdata.node.forEach(function (node) {
            node.itemStyle = null;
            node.label = {
                normal: {
                    show: node.symbolSize > 15
                }
            };
            //node.category = Math.ceil(node.value * 8 / maxdeg);
        });

        //图例
/*        var categories = [];
        for (var i = 0; i < n_class; i++) {
            categories[i] = {
                name: '集团' + (i+1)
            };
        }*/
        for(var i = 0; i < roadNum; i++){
            countryIn[roaddata[i].to] += 1 ;
            countryOut[roaddata[i].from] += 1;
            graphdata.link.push({
                    id:i,
                    source: countryOut[roaddata[i].from],
                    target: roaddata[i].to,
            });
        }

        var myGraphchart = echarts.init(document.getElementById('Graphcontainer'));
         option = {
                    tooltip: {
                            show: true, // 默认显示
                            showContent: true, // 是否显示提示框浮层
                            trigger: 'item', // 触发类型，默认数据项触发
                            triggerOn: 'mousemove', // 提示触发条件，mousemove鼠标移至触发，还有click点击触发
                            alwaysShowContent: true, // 默认离开提示框区域隐藏，true为一直显示
                            showDelay: 100, // 浮层显示的延迟，单位为 ms，默认没有延迟，也不建议设置。在 triggerOn 为 'mousemove' 时有效。
                            hideDelay: 2000, // 浮层隐藏的延迟，单位为 ms，在 alwaysShowContent 为 true 的时候无效。
                            enterable: false, // 鼠标是否可进入提示框浮层中，默认为false，如需详情内交互，如添加链接，按钮，可设置为 true。
                            position: 'right', // 提示框浮层的位置，默认不设置时位置会跟随鼠标的位置。只在 trigger 为'item'的时候有效。
                            confine: false, 
                            transitionDuration: 0.2, // 提示框浮层的移动动画过渡时间，单位是秒，设置为 0 的时候会紧跟着鼠标移动。
                        },
                    legend: [{
                        // selectedMode: 'single',
                       
                    }],
                    animationDuration: 1500,
                    animationEasingUpdate: 'quinticInOut',
                    series : [
                        {
                            name: '国家',
                            type: 'graph',
                            layout: 'circular',
                            data: graphdata.node,
                            links: graphdata.link,
                            //categories: categories,
                            roam: true, 
                            nodeScaleRatio: 0.6, // 鼠标漫游缩放时节点的相应缩放比例，当设为0时节点不随着鼠标的缩放而缩放
                            focusNodeAdjacency: true, 
                            edgeSymbol: ['none', 'arrow'], 
                            edgeSymbolSize: 5,
                            itemStyle: { // ========图形样式，有 normal 和 emphasis 两个状态。
                                // normal 是图形在默认状态下的样式；
                                // emphasis 是图形在高亮状态下的样式，比如在鼠标悬浮或者图例联动高亮时。
                                normal: { // 默认样式
                                    label: {
                                        show: true
                                    },
                                    borderType: 'dashed', // 图形描边类型，默认为实线，支持 'solid'（实线）, 'dashed'(虚线), 'dotted'（点线）。
                                    borderColor: 'rgba(205, 149, 12, 0.4)', // 设置图形边框为淡金色,透明度为0.4
                                    borderWidth: 2, // 图形的描边线宽。为 0 时无描边。
                                    opacity: 1 // 图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形。默认0.5

                                },
                                emphasis: { // 高亮状态

                                }
                            },
                            lineStyle: { // ========关系边的公用线条样式。
                                                                    //width: '1', //线的粗细
                                type: 'solid', // 线的类型 'solid'（实线）'dashed'（虚线）'dotted'（点线）
                                 // 线条的曲线程度，从0到1
                                opacity: 0.5,// 图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形。默认0.5
                                curveness: 0.3,
                                color: '#00FFFF',
                                emphasis: { // 高亮状态
                                }
                            },
                            label: { // ========结点图形上的文本标签
                                normal: {
                                    show: true, // 是否显示标签。
                                    position: 'inside',
                                    textStyle: { // 标签的字体样式
                                        color: '#d3d7d4', // 字体颜色 #cde6c7 #d1c7b7 #d9d6c3 #d3d7d4
                                        fontStyle: 'normal', // 文字字体的风格 'normal'标准 'italic'斜体 'oblique' 倾斜
                                        fontWeight: 'bolder', // 'normal'标准，'bold'粗的，'bolder'更粗的，'lighter'更细的，或100 | 200 | 300 | 400...
                                        fontFamily: 'sans-serif', // 文字的字体系列
                                        fontSize: 12, // 字体大小
                                    }
                                },
                                emphasis: { // 高亮状态
                                }
                            },

                        }
                    ]
                };
        myGraphchart.setOption(option)
        
        console.log(graphdata);
        function buildGraph(){

        }
</script>
</body>
</html>